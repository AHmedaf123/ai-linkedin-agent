name: Daily LinkedIn Post

on:
  schedule:
    # Pakistan Time = UTC+5
    # 12:00 AM PKT = 19:00 UTC (previous day)
    # 12:00 PM PKT = 07:00 UTC
    - cron: '0 19 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch: # Allow manual run

permissions:
  contents: write

concurrency:
  group: linkedin-posting
  cancel-in-progress: false

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      AI_LINKED_INSECRETS: ${{ secrets.AI_LINKED_INSECRETS }}
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Install Playwright browsers and dependencies to prevent runtime posting errors
      - name: Install Playwright browsers
        run: python -m playwright install --with-deps

      - name: Load packed secrets
        if: ${{ env.AI_LINKED_INSECRETS != '' }}
        run: |
          python - <<'PY'
          import os, json, sys
          data = os.environ.get("AI_LINKED_INSECRETS")
          if not data:
              print("AI_LINKED_INSECRETS secret is not set.", file=sys.stderr)
              sys.exit(1)
          try:
              j = json.loads(data)
          except Exception as e:
              print(f"Invalid JSON in AI_LINKED_INSECRETS: {e}", file=sys.stderr)
              sys.exit(1)
          with open(os.environ["GITHUB_ENV"], "a") as f:
              for k, v in j.items():
                  print(f"{k}={v}", file=f)
          PY

      - name: Run AI Agent
        run: python run.py --force

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts
          path: |
            post_preview.txt
            linkedin_agent.log
            structured_logs.json
            *_screenshot.png
            *_page.html
          if-no-files-found: ignore
          retention-days: 5

      - name: Commit state changes (if any)
        run: |
          if [ -f agent/state.json ]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add agent/state.json
            if ! git diff --cached --quiet; then
              git commit -m "chore(schedule): update state"
              git push
            else
              echo "No state changes to commit."
            fi
          else
            echo "No agent/state.json found; skipping commit."
          fi
